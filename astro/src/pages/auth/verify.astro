---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Weryfikacja logowania">
  <div class="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
    <div class="p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md max-w-md w-full text-center">
      <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Weryfikacja...</h2>
      <p id="status-message" class="text-gray-600 dark:text-gray-300">Trwa logowanie, proszę czekać.</p>
      <div id="loader" class="mt-6 flex justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { authService } from '../../lib/services/auth';

  async function verify() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const statusMessage = document.getElementById('status-message');
    const loader = document.getElementById('loader');

    if (!token) {
      if (statusMessage) statusMessage.innerText = "Brak tokenu weryfikacyjnego.";
      if (loader) loader.style.display = 'none';
      return;
    }

    try {
      console.log('Verifying magic link with token:', token.substring(0, 10) + '...');
      const data = await authService.verifyMagicLink(token);
      console.log('Verification successful, setting session');
      authService.setSession(data);
      
      if (statusMessage) statusMessage.innerText = "Zalogowano pomyślnie! Przekierowywanie...";
      
      // Redirect to dashboard after short delay
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 1000);
      
    } catch (error) {
      console.error('Verification error:', error);
      let errorMessage = "Nieznany błąd";
      
      if (error instanceof Error) {
        errorMessage = error.message;
        // If it's a fetch error, try to get more details
        if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
          errorMessage = "Błąd połączenia z serwerem. Sprawdź połączenie internetowe.";
        }
      } else if (typeof error === 'object' && error !== null) {
        errorMessage = JSON.stringify(error);
      }
      
      if (statusMessage) {
        statusMessage.innerText = "Błąd logowania: " + errorMessage;
        statusMessage.className = "text-gray-600 dark:text-gray-300 text-red-600 dark:text-red-400";
      }
      if (loader) loader.style.display = 'none';
    }
  }

  // Run verification on mount
  verify();
</script>